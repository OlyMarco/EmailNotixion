# EmailNotixion - 实时IMAP邮件推送插件

一个用于AstrBot的简洁高效邮件推送插件，支持多账号IMAP邮件监控和跨平台推送。

## 使用效果展示

<div align="center">
  <img src="left.png" alt="指令使用示例" width="45%" />
  <img src="right.png" alt="邮件推送效果" width="45%" />
</div>

## ✨ 核心特性

- **🔄 自动重建连接**：每2分钟自动重建所有邮箱连接，彻底解决长时间运行卡死问题
- **⚡ 超时保护**：所有操作均设置30秒超时，避免单个账号卡死影响整体服务
- **📱 跨平台兼容**：支持QQ、微信、钉钉等所有AstrBot支持的消息平台
- **🏷️ 多账号管理**：同时监控多个邮箱账号，统一推送管理
- **🛠️ 灵活配置**：可配置推送间隔、字符上限，支持实时调整
- **🔧 智能解析**：完美支持HTML邮件、富文本内容和多种编码格式
- **🔄 状态恢复**：插件重载后，用户发送任意消息即可自动恢复推送状态

## 🔄 稳定性保证

### 防卡死机制
- **定时重建**：每2分钟完全重建所有邮箱连接对象
- **超时控制**：IMAP连接30秒超时，邮件检查30秒超时
- **简单可靠**：移除复杂的健康检查和错误计数，采用直接重建策略

### 工作原理
```
启动服务 → 初始化连接 → 检查邮件(30s超时) → 等待间隔 → 重建连接(每2分钟) → 循环
```

## 👀 版本说明

### 🚀 v1.0.8 最新版本
- **🔄 智能新邮件检测** - 新邮件判定条件升级：未读且2分钟内，有效避免重构导致重复推送
- **🛡️ 防重复推送机制** - 解决同一邮件多次推送问题，确保每封邮件只推送一次
- **💾 状态持久化优化** - 重建连接时保留邮件检查状态，避免重置导致的重复推送
- **🔧 连接管理增强** - 优化通知器状态管理，错误恢复时不重置邮件进度

### 核心改进
- **智能时间过滤**: 只推送未读且2分钟内的邮件，配合重构间隔避免重复
- **重复推送防护**: 使用UID集合防止同一邮件在多个检查路径中重复处理
- **状态保持机制**: 重建连接时保留last_uid和检查状态，确保连续性
- **错误恢复优化**: 连接错误时只重置连接不重置邮件状态

<details>
<summary>📚 历史版本更新记录</summary>

### v1.0.7
- **🔄 简化连接管理** - 移除复杂的健康检查和reinit机制，采用直接重建策略
- **📨 保持邮件连续性** - 重建连接时保留邮件检查进度，确保不重复接收或遗漏邮件
- **定时重建策略**: 每2分钟完全重建所有EmailNotifier对象，确保连接始终新鲜
- **超时控制优化**: IMAP连接30秒超时，邮件检查30秒超时，服务停止5秒超时
- **简化错误处理**: 移除复杂的连续错误计数和指数退避，采用直接重建策略
- **手动重建命令**: `/email reinit` 命令支持手动重建所有连接
- **代码结构精简**: 移除健康检查、复杂的重新初始化等机制，代码更简洁可靠

### v1.0.6
- **💡 智能账号检测** - 新增IMAP连接测试，准确识别账号有效性
- **⚙️ 代码结构优化** - 重构核心代码架构，提升性能和可维护性
- **📝 指令系统改进** - 优化用户交互界面，增强状态显示逻辑
- **✨ 表情符号统一** - 完善用户界面体验，保持一致的视觉风格
- **🛠️ 配置管理增强** - 改进配置重载机制，确保实时生效

### v1.0.5
- **🔄 智能状态恢复机制** - 插件重载后，当用户在推送平台发送消息时自动恢复推送状态
- **📝 Event对象智能记录** - 通过全局消息监听器捕获用户消息并自动注册推送目标
- **🎛️ 后台管理支持** - 可在AstrBot后台直接管理推送目标和配置
- **⚙️ 配置指令优化** - 新增字符上限设置指令，所有配置实时生效
- **🔧 代码重构优化** - 精简代码结构，提升运行效率和维护性

### v1.0.4
- **重大更新**：跨消息平台兼容性全面优化
- **消息发送优化**：统一使用 event.send() 方法，确保消息准确送达
- **平台兼容性**：完美支持QQ、微信、钉钉等所有AstrBot支持的平台
- **性能提升**：异步非阻塞设计，多账号并发处理，不影响机器人性能
- **稳定性增强**：优化错误处理机制，提升长期运行稳定性
- **代码优化**：重构消息发送逻辑，消除重复发送问题

### v1.0.3
- **重大更新**：全面支持HTML邮件和卡片消息解析
- 增强HTML邮件解析：优化quoted-printable编码处理
- 智能内容提取：自动过滤CSS样式和JavaScript脚本
- 改进富文本转换：更准确的纯文本提取算法

### v1.0.2
- 增强平台兼容性：支持所有AstrBot支持的消息平台
- 改进邮件内容解析：支持HTML邮件和富文本内容
- 新增内容长度限制：可配置邮件主题和内容的最大字符数

</details>

## 🔧 快速开始

### 1. 添加邮箱账号
```
/email add imap.gmail.com,your-email@gmail.com,app_password
```

### 2. 开启邮件推送
```
/email on
```

### 3. 查看状态
```
/email
```

## ⚙️ 邮箱配置

### Gmail配置
1. 开启两步验证
2. 生成应用专用密码
3. 使用应用专用密码连接

```
/email add imap.gmail.com,your-email@gmail.com,app_password
```

### QQ邮箱配置
1. 开启IMAP服务
2. 获取授权码
3. 使用授权码连接

```
/email add imap.qq.com,123456@qq.com,authorization_code
```

### 其他邮箱
支持所有提供IMAP服务的邮箱，包括163、126、企业邮箱等。

## 🔄 自动状态恢复

### 工作原理
插件使用**触发式状态恢复**机制：

1. **保存推送目标**：使用 `/email on` 开启推送时，插件保存当前会话信息
2. **插件重载**：重载后推送状态暂时失效，但配置信息已保存
3. **触发恢复**：当用户在之前配置推送的平台发送任何消息时自动恢复

### 恢复步骤
```
# 1. 首次配置（在QQ群）
/email on              # 开启推送，插件保存会话信息

# 2. 插件重载后
Hello                  # 在同一QQ群向机器人发送任意消息
# ✅ 系统自动检测并恢复推送状态

# 3. 推送功能已自动恢复
```

## 📋 指令说明

### 基本指令：`/email` 或 `/mail`

| 指令 | 说明 |
|------|------|
| `/email` | 显示当前状态信息 |
| `/email on` / `/email off` | 开启/关闭邮件推送 |
| `/email help` | 显示详细指令帮助 |
| `/email debug` | 显示调试信息 |
| `/email list` | 查看账号列表和连接状态 |
| `/email reinit` | 手动重建所有连接 |

### 账号管理

| 指令 | 说明 |
|------|------|
| `/email add <配置>` | 添加邮箱账号 |
| `/email del <邮箱>` | 删除指定邮箱账号 |

格式：`/email add imap_server,email,password`

### 配置设置

| 指令 | 说明 |
|------|------|
| `/email interval <秒>` | 设置推送间隔（不带参数查看当前值） |
| `/email text <字符数>` | 设置字符上限（不带参数查看当前值） |

示例：
```
/email interval 5       # 设置为5秒检查一次
/email text 100        # 设置字符上限为100
/email reinit          # 手动重建所有连接
```

## ⚙️ 配置说明

### 推送间隔设置
- **最小间隔**：0.5秒
- **默认间隔**：3秒
- **推荐间隔**：3-10秒（避免频繁请求）

### 字符上限设置
- **最小字符数**：10字符
- **默认字符数**：50字符
- **作用范围**：邮件主题和内容的显示长度

### 重建间隔
- **固定间隔**：2分钟
- **作用**：自动重建所有邮箱连接，确保长期稳定运行

## ⚠️ 安全注意事项

### 密码安全
- **本插件将邮箱密码以明文形式存储在配置文件中**，存在安全风险
- 请务必使用**应用专用密码**或**授权码**，切勿使用账号登录密码
- 定期更换授权码/应用专用密码
- 确保配置文件访问权限受到适当保护

### 账号管理安全
- 及时清理不需要的账号配置
- 在不使用时及时关闭邮件推送功能
- 定期检查账号列表，确保没有未授权的配置

## 💡 常见问题

### Q: 为什么收不到邮件推送？
A: 请检查：
- 邮箱账号配置是否正确
- IMAP服务是否已开启
- 网络连接是否正常
- 推送服务是否已开启（`/email on`）

### Q: 插件运行久了会卡死吗？
A: 不会。新版本每2分钟自动重建所有连接，并设置30秒超时保护，彻底解决长时间运行卡死问题。

### Q: 支持哪些邮箱服务？
A: 支持所有提供IMAP服务的邮箱，包括但不限于：
- Gmail（需要应用专用密码）
- QQ邮箱（需要授权码）
- 163/126邮箱（需要授权码）
- 企业邮箱等

### Q: 如何获取应用专用密码/授权码？
A: 不同邮箱服务提供商的设置方法不同：
- **Gmail**: 账户设置 → 安全性 → 应用专用密码
- **QQ邮箱**: 设置 → 账户 → POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务
- **163邮箱**: 设置 → POP3/SMTP/IMAP → 客户端授权密码

### Q: 重建连接会影响邮件接收吗？
A: 不会。重建连接时会保留邮件检查进度（last_uid），确保不会重复接收或遗漏邮件。

### Q: v1.0.8版本有什么重要改进？
A: v1.0.8版本专注解决邮件重复推送问题：
- **智能时间过滤**：只推送未读且2分钟内的邮件，配合重构机制避免重复
- **防重复机制**：解决同一邮件在多个检查路径中重复处理的问题
- **状态持久化**：重建连接和错误恢复时保持邮件检查状态，确保连续性
- **更加可靠**：彻底解决重复推送问题，保持高稳定性

### Q: 从旧版本升级需要重新配置吗？
A: 不需要。v1.0.8版本完全向后兼容，所有现有配置（邮箱账号、推送目标、间隔设置等）都会自动保留。

## 🔧 技术说明

### 核心技术特性
- **异步非阻塞设计**：不会阻塞机器人主线程
- **IMAP UID机制**：基于UID检测新邮件，确保可靠性
- **超时保护机制**：30秒超时避免连接卡死
- **定期重建策略**：每2分钟完全重建连接对象
- **跨平台兼容**：统一使用 event.send() 方法
- **多账号并发**：支持多账号并发处理

### 邮件解析能力
- **HTML邮件解析**：完美支持HTML格式邮件
- **多编码支持**：支持quoted-printable、base64等编码
- **智能内容提取**：自动过滤CSS样式和JavaScript
- **富文本转换**：智能转换为易读的纯文本

### 稳定性保证
- **简单直接**：移除复杂的健康检查和错误计数机制
- **定时重建**：每2分钟重建所有连接，确保始终新鲜
- **超时控制**：所有网络操作都有超时保护
- **状态持久化**：配置自动保存，重启后恢复

## 🔍 使用建议

- 推送间隔建议设置为3-5秒，既能及时接收又不会给服务器造成压力
- 使用`/email reinit`可以手动重建连接，解决临时连接问题
- 定期查看`/email debug`了解插件运行状态
- 如遇到问题，可以尝试关闭推送后重新开启
